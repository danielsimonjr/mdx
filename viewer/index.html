<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDX Viewer - Markdown Extended Container</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --accent: #f59e0b;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        background: var(--background);
        color: var(--text);
        line-height: 1.6;
        min-height: 100vh;
    }

    /* Header */
    .header {
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.25rem;
        font-weight: 700;
    }

    .logo-icon {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1rem;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    /* Main Layout */
    .main-container {
        display: flex;
        height: calc(100vh - 65px);
    }

    /* Sidebar */
    .sidebar {
        width: 280px;
        background: var(--surface);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .sidebar-section {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .sidebar-section h3 {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 0.75rem;
    }

    .toc-list {
        list-style: none;
    }

    .toc-item {
        padding: 0.375rem 0;
    }

    .toc-link {
        color: var(--text);
        text-decoration: none;
        font-size: 0.9rem;
        display: block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        transition: background 0.15s;
    }

    .toc-link:hover {
        background: var(--surface-light);
    }

    .toc-link.h3 {
        padding-left: 1.5rem;
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .asset-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .asset-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--surface-light);
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background 0.15s;
    }

    .asset-item:hover {
        background: var(--border);
    }

    .asset-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .asset-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Content Area */
    .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 2rem 4rem;
    }

    .document-meta {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
    }

    .document-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .document-description {
        color: var(--text-muted);
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }

    .meta-tags {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .meta-tag {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    /* Markdown Content */
    .markdown-content {
        max-width: 800px;
    }

    .markdown-content h1 {
        font-size: 2rem;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border);
    }

    .markdown-content h2 {
        font-size: 1.5rem;
        margin-top: 2rem;
        margin-bottom: 0.75rem;
    }

    .markdown-content h3 {
        font-size: 1.25rem;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .markdown-content p {
        margin-bottom: 1rem;
    }

    .markdown-content ul, .markdown-content ol {
        margin-bottom: 1rem;
        padding-left: 1.5rem;
    }

    .markdown-content li {
        margin-bottom: 0.5rem;
    }

    .markdown-content code {
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        background: var(--surface-light);
        padding: 0.2em 0.4em;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .markdown-content pre {
        margin: 1.5rem 0;
        border-radius: 8px;
        overflow: hidden;
    }

    .markdown-content pre code {
        display: block;
        padding: 1.25rem;
        background: var(--surface);
        overflow-x: auto;
    }

    .markdown-content img {
        max-width: 100%;
        border-radius: 8px;
        margin: 1.5rem 0;
    }

    .markdown-content blockquote {
        border-left: 4px solid var(--primary);
        margin: 1.5rem 0;
        padding: 0.75rem 1.25rem;
        background: var(--surface);
        border-radius: 0 8px 8px 0;
    }

    .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5rem 0;
    }

    .markdown-content th, .markdown-content td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .markdown-content th {
        background: var(--surface);
        font-weight: 600;
    }

    .markdown-content a {
        color: var(--primary);
        text-decoration: none;
    }

    .markdown-content a:hover {
        text-decoration: underline;
    }

    /* Admonitions */
    .admonition {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin: 1.5rem 0;
        border-left: 4px solid;
    }

    .admonition-info {
        background: rgba(59, 130, 246, 0.1);
        border-color: var(--info);
    }

    .admonition-warning {
        background: rgba(245, 158, 11, 0.1);
        border-color: var(--warning);
    }

    .admonition-danger {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--danger);
    }

    .admonition-tip {
        background: rgba(34, 197, 94, 0.1);
        border-color: var(--success);
    }

    /* v1.1 Alignment classes */
    .align-left { text-align: left; }
    .align-center { text-align: center; }
    .align-right { text-align: right; }
    .align-justify { text-align: justify; }

    /* Right Panel */
    .right-panel {
        width: 300px;
        background: var(--surface);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .panel-tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
    }

    .panel-tab {
        flex: 1;
        padding: 0.75rem;
        text-align: center;
        font-size: 0.85rem;
        cursor: pointer;
        background: transparent;
        border: none;
        color: var(--text-muted);
        transition: all 0.15s;
    }

    .panel-tab:hover {
        background: var(--surface-light);
    }

    .panel-tab.active {
        color: var(--primary);
        border-bottom: 2px solid var(--primary);
    }

    .panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .version-item {
        padding: 0.75rem;
        background: var(--surface-light);
        border-radius: 8px;
        margin-bottom: 0.75rem;
    }

    .version-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .version-tag {
        background: var(--primary);
        color: white;
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .version-date {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .version-message {
        font-size: 0.85rem;
    }

    .version-author {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
    }

    .annotation-item {
        padding: 0.75rem;
        background: var(--surface-light);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border-left: 3px solid;
    }

    .annotation-item.comment {
        border-color: var(--info);
    }

    .annotation-item.highlight {
        border-color: var(--warning);
    }

    .annotation-item.suggestion {
        border-color: var(--success);
    }

    .annotation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .annotation-type {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
    }

    .annotation-quote {
        font-size: 0.8rem;
        font-style: italic;
        color: var(--text-muted);
        padding: 0.5rem;
        background: var(--surface);
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }

    .annotation-body {
        font-size: 0.85rem;
    }

    .annotation-author {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
    }

    /* Upload Zone */
    .upload-zone {
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 3rem;
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
        margin: 2rem;
    }

    .upload-zone:hover, .upload-zone.dragover {
        border-color: var(--primary);
        background: rgba(37, 99, 235, 0.05);
    }

    .upload-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .upload-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .upload-subtitle {
        color: var(--text-muted);
        margin-bottom: 1rem;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.15s;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    .btn-secondary {
        background: var(--surface-light);
        color: var(--text);
    }

    .btn-secondary:hover {
        background: var(--border);
    }

    /* Welcome State */
    .welcome-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
    }

    .feature-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-top: 2rem;
        max-width: 800px;
    }

    .feature-card {
        background: var(--surface);
        padding: 1.5rem;
        border-radius: 12px;
        text-align: left;
    }

    .feature-icon {
        font-size: 1.5rem;
        margin-bottom: 0.75rem;
    }

    .feature-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .feature-desc {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    /* Utility */
    .hidden {
        display: none !important;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--surface);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--secondary);
    }
</style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">MDX</div>
            <span>MDX Viewer</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" id="openFileBtn">
                üìÇ Open File
            </button>
            <button class="btn btn-primary" id="downloadSampleBtn">
                ‚¨áÔ∏è Download Sample
            </button>
        </div>
    </header>

    <main class="main-container">
    <!-- Welcome State (shown when no document loaded) -->
    <div class="welcome-state" id="welcomeState">
        <div class="upload-zone" id="uploadZone">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-title">Drop an MDX file here</div>
            <div class="upload-subtitle">or click to browse</div>
            <button class="btn btn-primary">Select File</button>
        </div>
        <input type="file" id="fileInput" accept=".mdx,.zip" style="display: none;">
        
        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-icon">üìù</div>
                <div class="feature-title">Rich Markdown</div>
                <div class="feature-desc">Full CommonMark support with extensions for tables, footnotes, and math</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üé¨</div>
                <div class="feature-title">Embedded Media</div>
                <div class="feature-desc">Images, videos, audio, 3D models, and data files all bundled together</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üì¶</div>
                <div class="feature-title">Self-Contained</div>
                <div class="feature-desc">Everything in one portable file‚Äîno broken links, no missing assets</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üîì</div>
                <div class="feature-title">Open Format</div>
                <div class="feature-desc">Standard ZIP archive‚Äîextract and read with any tools you have</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üìú</div>
                <div class="feature-title">Version History</div>
                <div class="feature-desc">Built-in tracking of document revisions with full snapshots</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üí¨</div>
                <div class="feature-title">Annotations</div>
                <div class="feature-desc">Comments, highlights, and suggestions without modifying content</div>
            </div>
        </div>
    </div>

    <!-- Document View (shown when document loaded) -->
    <aside class="sidebar hidden" id="sidebar">
        <div class="sidebar-section">
            <h3>Table of Contents</h3>
            <ul class="toc-list" id="tocList">
                <!-- Populated by JS -->
            </ul>
        </div>
        <div class="sidebar-section" style="flex: 1; overflow-y: auto;">
            <h3>Assets</h3>
            <div class="asset-list" id="assetList">
                <!-- Populated by JS -->
            </div>
        </div>
    </aside>

    <section class="content-area hidden" id="contentArea">
        <div class="document-meta" id="documentMeta">
            <!-- Populated by JS -->
        </div>
        <article class="markdown-content" id="markdownContent">
            <!-- Populated by JS -->
        </article>
    </section>

    <aside class="right-panel hidden" id="rightPanel">
        <div class="panel-tabs">
            <button class="panel-tab active" data-panel="info">Info</button>
            <button class="panel-tab" data-panel="versions">Versions</button>
            <button class="panel-tab" data-panel="annotations">Notes</button>
        </div>
        <div class="panel-content" id="panelContent">
            <!-- Populated by JS -->
        </div>
    </aside>
</main>

<script>
    // MDX Viewer Application
    class MDXViewer {
        constructor() {
            this.document = null;
            this.assets = new Map();
            this.currentPanel = 'info';
            
            this.initializeElements();
            this.bindEvents();
        }

        initializeElements() {
            this.welcomeState = document.getElementById('welcomeState');
            this.sidebar = document.getElementById('sidebar');
            this.contentArea = document.getElementById('contentArea');
            this.rightPanel = document.getElementById('rightPanel');
            this.uploadZone = document.getElementById('uploadZone');
            this.fileInput = document.getElementById('fileInput');
            this.tocList = document.getElementById('tocList');
            this.assetList = document.getElementById('assetList');
            this.documentMeta = document.getElementById('documentMeta');
            this.markdownContent = document.getElementById('markdownContent');
            this.panelContent = document.getElementById('panelContent');
        }

        bindEvents() {
            // File input
            this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
            this.uploadZone.addEventListener('click', () => this.fileInput.click());
            
            // Drag and drop
            this.uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                this.uploadZone.classList.add('dragover');
            });
            this.uploadZone.addEventListener('dragleave', () => {
                this.uploadZone.classList.remove('dragover');
            });
            this.uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                this.uploadZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    this.loadFile(e.dataTransfer.files[0]);
                }
            });

            // Header buttons
            document.getElementById('openFileBtn').addEventListener('click', () => {
                this.fileInput.click();
            });
            
            document.getElementById('downloadSampleBtn').addEventListener('click', () => {
                this.downloadSample();
            });

            // Panel tabs
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    this.currentPanel = tab.dataset.panel;
                    this.renderPanel();
                });
            });
        }

        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.loadFile(file);
            }
        }

        async loadFile(file) {
            try {
                const zip = new JSZip();
                const contents = await zip.loadAsync(file);
                
                // Read manifest
                const manifestFile = contents.file('manifest.json');
                if (!manifestFile) {
                    throw new Error('Invalid MDX file: missing manifest.json');
                }
                const manifestText = await manifestFile.async('text');
                this.document = {
                    manifest: JSON.parse(manifestText)
                };

                // Read main content
                const entryPoint = this.document.manifest.content?.entry_point || 'document.md';
                const contentFile = contents.file(entryPoint);
                if (contentFile) {
                    this.document.content = await contentFile.async('text');
                }

                // Read all assets
                this.assets.clear();
                for (const [path, zipEntry] of Object.entries(contents.files)) {
                    if (!zipEntry.dir && path !== 'manifest.json' && path !== entryPoint) {
                        const data = await zipEntry.async('blob');
                        this.assets.set(path, URL.createObjectURL(data));
                    }
                }

                // Read version history
                const versionsFile = contents.file('history/versions.json');
                if (versionsFile) {
                    const versionsText = await versionsFile.async('text');
                    this.document.versions = JSON.parse(versionsText);
                }

                // Read annotations
                const annotationsFile = contents.file('annotations/annotations.json');
                if (annotationsFile) {
                    const annotationsText = await annotationsFile.async('text');
                    this.document.annotations = JSON.parse(annotationsText);
                }

                this.renderDocument();
            } catch (error) {
                console.error('Error loading MDX file:', error);
                alert('Error loading file: ' + error.message);
            }
        }

        renderDocument() {
            // Show document UI
            this.welcomeState.classList.add('hidden');
            this.sidebar.classList.remove('hidden');
            this.contentArea.classList.remove('hidden');
            this.rightPanel.classList.remove('hidden');

            // Render components
            this.renderMeta();
            this.renderContent();
            this.renderToc();
            this.renderAssets();
            this.renderPanel();
        }

        renderMeta() {
            const doc = this.document.manifest.document;
            const authors = doc.authors || [];
            
            this.documentMeta.innerHTML = `
                <h1 class="document-title">${this.escapeHtml(doc.title)}</h1>
                ${doc.description ? `<p class="document-description">${this.escapeHtml(doc.description)}</p>` : ''}
                <div class="meta-tags">
                    <span class="meta-tag">üìÖ ${new Date(doc.modified).toLocaleDateString()}</span>
                    ${doc.version ? `<span class="meta-tag">üè∑Ô∏è v${doc.version}</span>` : ''}
                    ${authors.length ? `<span class="meta-tag">üë§ ${authors.map(a => a.name).join(', ')}</span>` : ''}
                </div>
            `;
        }

        renderContent() {
            let content = this.document.content || '';
            
            // Replace asset paths with blob URLs
            // Replace asset paths with blob URLs (supports both assets/ and media/ for backwards compatibility)
            for (const [path, url] of this.assets) {
                content = content.replace(
                    new RegExp(`\\]\\(${path.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\)`, 'g'),
                    `](${url})`
                );
            }

            // Process extended directives (simple version)
            content = this.processDirectives(content);

            // Render markdown
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                }
            });

            this.markdownContent.innerHTML = marked.parse(content);
        }

        processDirectives(content) {
            // v1.1: Process alignment shorthand notation {:.left}, {:.center}, etc.
            content = content.replace(
                /^\{:\.(left|center|right|justify)\}\s*$/gm,
                '<div class="align-$1">'
            );

            // v1.1: Process heading alignment
            content = content.replace(
                /^(#{1,6})\s+(.+?)\s*\{:\.(left|center|right|justify)\}$/gm,
                (match, hashes, text, align) => {
                    return `${hashes} <span class="align-${align}">${text.trim()}</span>`;
                }
            );

            // v1.1: Process container blocks ::::{.align-center} ... ::::
            content = content.replace(
                /^::::\s*\{\.(align-(?:left|center|right|justify))\}\s*$/gm,
                '<div class="$1">'
            );
            content = content.replace(/^::::$/gm, '</div>');

            // v1.1: Process ::::note blocks with 4 colons
            content = content.replace(
                /::::note\{type="(\w+)"\}([\s\S]*?)::::/g,
                (match, type, body) => {
                    return `<div class="admonition admonition-${type}">${marked.parse(body.trim())}</div>`;
                }
            );

            // Process :::note blocks (v1.0 compat with 3 colons)
            content = content.replace(
                /:::note\{type="(\w+)"\}([\s\S]*?):::/g,
                (match, type, body) => {
                    return `<div class="admonition admonition-${type}">${marked.parse(body.trim())}</div>`;
                }
            );

            // Process ::video directives (simplified)
            content = content.replace(
                /::video\[([^\]]*)\]\{src="([^"]+)"[^}]*\}/g,
                (match, title, src) => {
                    const url = this.assets.get(src) || src;
                    return `<video controls style="max-width:100%;border-radius:8px;margin:1rem 0;"><source src="${url}"></video>`;
                }
            );

            // Process ::model directives (show preview)
            content = content.replace(
                /::model\[([^\]]*)\]\{[^}]*preview="([^"]+)"[^}]*\}/g,
                (match, title, preview) => {
                    const url = this.assets.get(preview) || preview;
                    return `<figure style="margin:1rem 0;"><img src="${url}" alt="${title}"><figcaption style="text-align:center;color:var(--text-muted);font-size:0.9rem;margin-top:0.5rem;">üéÆ ${title} (3D model - interactive in enhanced viewer)</figcaption></figure>`;
                }
            );

            // Process ::data directives
            content = content.replace(
                /::data\[([^\]]*)\]\{src="([^"]+)"[^}]*\}/g,
                (match, title, src) => {
                    return `<p><a href="${this.assets.get(src) || '#'}" download>üìä ${title} (Download data file)</a></p>`;
                }
            );

            return content;
        }

        renderToc() {
            const headings = this.markdownContent.querySelectorAll('h1, h2, h3');
            let tocHtml = '';
            
            headings.forEach((heading, index) => {
                const id = `heading-${index}`;
                heading.id = id;
                const level = heading.tagName.toLowerCase();
                tocHtml += `
                    <li class="toc-item">
                        <a href="#${id}" class="toc-link ${level}">${heading.textContent}</a>
                    </li>
                `;
            });

            this.tocList.innerHTML = tocHtml;
        }

        renderAssets() {
            const assets = this.document.manifest.assets || {};
            let html = '';

            const categories = [
                { key: 'images', icon: 'üñºÔ∏è', label: 'Images' },
                { key: 'video', icon: 'üé¨', label: 'Video' },
                { key: 'audio', icon: 'üéµ', label: 'Audio' },
                { key: 'models', icon: 'üì¶', label: '3D Models' },
                { key: 'documents', icon: 'üìÑ', label: 'Documents' },
                { key: 'data', icon: 'üìä', label: 'Data' }
            ];

            for (const cat of categories) {
                const items = assets[cat.key] || [];
                for (const item of items) {
                    const name = item.path.split('/').pop();
                    html += `
                        <div class="asset-item" data-path="${item.path}">
                            <span class="asset-icon">${cat.icon}</span>
                            <span class="asset-name">${name}</span>
                        </div>
                    `;
                }
            }

            this.assetList.innerHTML = html || '<p style="color:var(--text-muted);font-size:0.85rem;">No assets</p>';
        }

        renderPanel() {
            switch (this.currentPanel) {
                case 'info':
                    this.renderInfoPanel();
                    break;
                case 'versions':
                    this.renderVersionsPanel();
                    break;
                case 'annotations':
                    this.renderAnnotationsPanel();
                    break;
            }
        }

        renderInfoPanel() {
            const manifest = this.document.manifest;
            const doc = manifest.document;
            
            this.panelContent.innerHTML = `
                <div style="font-size:0.9rem;">
                    <p><strong>ID:</strong> ${doc.id}</p>
                    <p><strong>Created:</strong> ${new Date(doc.created).toLocaleString()}</p>
                    <p><strong>Modified:</strong> ${new Date(doc.modified).toLocaleString()}</p>
                    ${doc.version ? `<p><strong>Version:</strong> ${doc.version}</p>` : ''}
                    ${manifest.content?.markdown_variant ? `<p><strong>Format:</strong> ${manifest.content.markdown_variant}</p>` : ''}
                    
                    <h4 style="margin-top:1.5rem;margin-bottom:0.5rem;">Authors</h4>
                    ${(doc.authors || []).map(a => `
                        <p>${a.name}${a.email ? ` <span style="color:var(--text-muted)">(${a.email})</span>` : ''}</p>
                    `).join('')}
                    
                    <h4 style="margin-top:1.5rem;margin-bottom:0.5rem;">Features</h4>
                    <p>‚úì ${manifest.collaboration?.allow_annotations ? 'Annotations enabled' : 'Annotations disabled'}</p>
                    <p>‚úì ${manifest.history?.tracking_enabled ? 'Version history enabled' : 'No version history'}</p>
                </div>
            `;
        }

        renderVersionsPanel() {
            const versions = this.document.versions?.versions || [];
            
            if (!versions.length) {
                this.panelContent.innerHTML = '<p style="color:var(--text-muted);font-size:0.9rem;">No version history available</p>';
                return;
            }

            const html = versions.slice().reverse().map(v => `
                <div class="version-item">
                    <div class="version-header">
                        <span class="version-tag">v${v.version}</span>
                        <span class="version-date">${new Date(v.timestamp).toLocaleDateString()}</span>
                    </div>
                    <div class="version-message">${this.escapeHtml(v.message)}</div>
                    <div class="version-author">${v.author?.name || 'Unknown'}</div>
                </div>
            `).join('');

            this.panelContent.innerHTML = html;
        }

        renderAnnotationsPanel() {
            const annotations = this.document.annotations?.annotations || [];
            
            if (!annotations.length) {
                this.panelContent.innerHTML = '<p style="color:var(--text-muted);font-size:0.9rem;">No annotations</p>';
                return;
            }

            const html = annotations.map(a => `
                <div class="annotation-item ${a.type}">
                    <div class="annotation-header">
                        <span class="annotation-type">${a.type}</span>
                    </div>
                    ${a.target?.selector?.exact ? `
                        <div class="annotation-quote">"${this.escapeHtml(a.target.selector.exact)}"</div>
                    ` : ''}
                    <div class="annotation-body">${this.escapeHtml(a.body?.value || '')}</div>
                    <div class="annotation-author">${a.author?.name || 'Unknown'}</div>
                </div>
            `).join('');

            this.panelContent.innerHTML = html;
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        downloadSample() {
            // Create a minimal sample MDX file
            const zip = new JSZip();
            
            const manifest = {
                mdx_version: "1.0.0",
                document: {
                    id: crypto.randomUUID(),
                    title: "Sample MDX Document",
                    description: "A simple example of the MDX format",
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    version: "1.0.0",
                    authors: [{ name: "MDX Viewer", role: "generator" }]
                },
                content: {
                    entry_point: "document.md",
                    encoding: "UTF-8",
                    markdown_variant: "CommonMark"
                },
                assets: { images: [], video: [], audio: [], models: [], documents: [], data: [] }
            };

            const content = `# Sample MDX Document
```

## Welcome to MDX

This is a **sample document** demonstrating the MDX format.

### Features

- Human-readable Markdown content
- Self-contained assets
- Version history
- Collaborative annotations

### Code Example

```javascript
const greeting = ‚ÄúHello, MDX!‚Äù;
console.log(greeting);
```

### Next Steps

1. Create your own content
1. Add images and media
1. Share with others

-----

*Generated by MDX Viewer*
`;

```
            zip.file('manifest.json', JSON.stringify(manifest, null, 2));
            zip.file('document.md', content);

            zip.generateAsync({ type: 'blob' }).then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sample-document.mdx';
                a.click();
                URL.revokeObjectURL(url);
            });
        }
    }

    // Initialize the viewer
    document.addEventListener('DOMContentLoaded', () => {
        new MDXViewer();
    });
</script>
```

</body>
</html>